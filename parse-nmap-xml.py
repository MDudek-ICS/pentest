#!/usr/bin/python

# this script takes nmap xml files as input and finds
# all the IP addresses with the associated FQDN names and detect nbt names
#
# nmap should be ran like this: nmap -sS -vv --script=smb-mbenum.nse <target> -oX <output>
# 

import sys,fileinput
import lxml.etree as etree

def openfile():
  return open(sys.argv[1], 'r')

def main():
  xmlfile = openfile()
  print(xmlfile.name)
  tree = etree.parse(xmlfile)
  hosts = tree.findall('host')
  for host in hosts:
  
    address = host.find('address')
    host_ip = address.attrib.get('addr')
    
    host_dns = ""
    hostnames = host.xpath('.//hostname')
    for hostname in hostnames:
      host_dns = hostname.attrib.get('name')
    
    host_nbt = ""
    scripts = host.xpath('.//script')
    for script in scripts:
      if script.attrib.get('id') == "nbstat":
        host_nbt = ((script.attrib.get('output').split(",",1))[0].split(" "))[2]
    
    host_os = ""
    osmatches = host.xpath('.//osmatch')
    for osmatch in osmatches:
      if host_os == "":
        host_os = osmatch.attrib.get('name')
      if host_os != "":
        host_os = host_os + "; " + osmatch.attrib.get('name')
    
    print(host_ip,host_dns,host_nbt,host_os)
  
  xmlfile.close()

if __name__ == "__main__":
    main()